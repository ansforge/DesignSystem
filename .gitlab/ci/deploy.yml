################################################################################
# Deploy template.
################################################################################

.deploy:
  script:
    # Copy artifact that delete files in destination.
    - rsync -rah --exclude={'dump/*','private/*','web/sites/default/*local*','web/sites/default/files/*','.git*','.sonar/*','.env','.docksal/*local*','.docksal/settings/*local*'} --delete -e "ssh -o StrictHostKeyChecking=no" ./ $ENV_USER@$ENV_IP:$DIRECTORY
    # Run update
    - ssh -o StrictHostKeyChecking=no $ENV_USER@$ENV_IP "cd $DIRECTORY; fin project start; fin esante/update --translate;"
    - |
      ssh -o StrictHostKeyChecking=no $ENV_USER@$ENV_IP "echo -e '{
        \"project\": \"${CI_PROJECT_NAME}\",
        \"build_date\": \"$(date +"%Y-%m-%d %H:%M:%S %Z")\",
        \"deploy_date\": \"$(date +"%Y-%m-%d %H:%M:%S %Z")\",
        \"version\": \"${CI_COMMIT_BRANCH}\",
        \"env\": \"RUI\",
        \"job_name\": \"${CI_JOB_NAME}\"
      }' > $DIRECTORY/version.json"
