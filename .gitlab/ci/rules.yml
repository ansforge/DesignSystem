################################################################################
# Rules template.
#
# Gitlab-CI rules documentation:
# @see https://docs.gitlab.com/ee/ci/yaml/#rules
################################################################################

################################################################################
# Basic rules.
################################################################################
# internal git
.git_interne:
  rules:
    - if: $CI_SERVER_HOST == "git.kleegroup.com"
      when: never
# external git
.git_externe:
  rules:
    - if: $CI_SERVER_HOST == "gitlab-interne.dev.klee.lan.net"
      when: never
# used by deploy-rui-sante and sonar on develop branch
.develop:
  rules:
    - if: $CI_COMMIT_BRANCH == "develop" && $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULER == "santefr"
    - if: $CI_COMMIT_BRANCH == "develop"
      when: manual
# release branch
.release:
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^release\//
# merge request restrictions
.merge_request_restriction:
  rules:
    - if: $CI_MERGE_REQUEST_TITLE =~ /^Draft/
      when: never
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME == "develop"
      when: never
    - if: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME =~ /^release\//
      when: never
.merge_request:
  rules:
    - !reference [.merge_request_restriction, rules]
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
# new tag
.tags:
  rules:
    - if: $CI_COMMIT_TAG

################################################################################
# Build.
################################################################################
.build_rules:
  rules:
    # Develop branch and internal git
    - !reference [.develop, rules]
    # Release branch and external git
    - if: $CI_COMMIT_BRANCH =~ /^release\// && $CI_SERVER_HOST == "git.kleegroup.com"
    # Tag and external git
    - if: $CI_COMMIT_TAG && $CI_SERVER_HOST == "git.kleegroup.com"

.to_merge_php_and_build_rules:
  rules:
    - !reference [.merge_request_restriction, rules]
    # Merge request
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_SERVER_HOST == "gitlab-interne.dev.klee.lan.net"
      changes:
        - "**/*.{php,module,install,profile,theme,yml,json,lock,twig}"
    - !reference [.build_rules, rules]

################################################################################
# Merge request.
################################################################################
.to_merge_php:
  extends: .rui_runner
  rules:
    - !reference [.git_interne, rules]
    - !reference [.merge_request_restriction, rules]
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*.{php,module,install,profile,theme,yml,json,lock,twig}"


.to_merge_css:
  extends: .rui_runner
  rules:
    - !reference [.git_interne, rules]
    - !reference [.merge_request_restriction, rules]
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "web/themes/custom/g_nius/**/*.{css,scss,json}"

################################################################################
# RUI rules.
################################################################################
#Only run for develop branch on internal git.
.rui_sante_rules:
  extends: .rui_runner
  rules:
    - !reference [.git_interne, rules]
    - !reference [.develop, rules]

################################################################################
# RUE rules.
################################################################################
#Only run for release branch on external git.
.rue_sante_rules:
  extends: .rue_runner
  rules:
    - !reference [.git_externe, rules]
    - !reference [.release, rules]

################################################################################
# Release/Tag.
################################################################################
#Only run for new tag in external git.
.tags_rules:
  extends: .rue_runner
  rules:
    - !reference [.git_externe, rules]
    - !reference [.tags, rules]
